#
# U-Boot bootscript for EMMC/SD images created by Yocto.
#

# Back up environment variables
setenv ORIG_overlays ${overlays}
setenv ORIG_extra_bootargs ${extra_bootargs}

# Set SOC type to "imx8mn" if not already defined by U-Boot
if test ! -n "${soc_type}"; then
	setenv soc_type "imx8mn"
fi

#
# Determine overlays to apply depending on the hardware capabilities
# described by the HWID, SOM version, and carrier board version.
#
if test -n "${module_ram}"; then
	setexpr som_hv ${hwid_2} \& 38
	setexpr som_hv ${som_hv} / 8

	setexpr module_has_wifi ${hwid_2} \& 10000
	setexpr module_has_wifi ${module_has_wifi} / 10000
	setexpr module_has_bt ${hwid_2} \& 20000
	setexpr module_has_bt ${module_has_bt} / 20000

	if test "${module_has_bt}" = "1" && test -z "${disable_bt}"; then
		setenv overlays _ov_som_bt_ccimx8mn.dtbo,${overlays}
	fi

	if test "${module_has_wifi}" = "1" && test -z "${disable_wifi}"; then
		setenv overlays _ov_som_wifi_ccimx8mn.dtbo,${overlays}
	fi

	if test "${som_hv}" = "1"; then
		setenv overlays _ov_som_v1_ccimx8mn.dtbo,${overlays}
	fi
fi

# Apply quad overlay if the SOC type is "imx8mn"
if test "${soc_type}" = "imx8mn"; then
	setenv overlays _ov_som_quad_ccimx8mn.dtbo,${overlays}
fi

# Apply DVK v1-v2 overlay if the board version is < 3
if test "${board_version}" -lt "3"; then
	setenv overlays _ov_board_v1-v2_ccimx8mn-dvk.dtbo,${overlays}
fi

# Get the UUID of the configured boot partition.
part uuid mmc ${mmcbootdev}:${mmcpart} bootpart
# Check the boot source.
if test "${bootpart}" = "${part1_uuid}"; then
	# We are booting from the eMMC using 'linux'.
	true
elif test "${bootpart}" = "${part2_uuid}"; then
	# We are booting from the eMMC using 'recovery'.
	setenv boot_initrd true
	setenv initrd_file uramdisk-recovery.img
else
	# We are booting from the SD card.
	setenv mmcroot /dev/mmcblk${mmcbootdev}p2
fi
setenv extra_bootargs fbcon=logo-pos:center ${extra_bootargs}
dboot linux mmc ${mmcbootdev}:${mmcpart}



# We only get here in case of an error on the dboot command.

# Undo changes to environment variables
setenv overlays ${ORIG_overlays}
setenv ORIG_overlays
setenv extra_bootargs ${ORIG_extra_bootargs}
setenv ORIG_extra_bootargs
